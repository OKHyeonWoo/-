<%
page_id= "member"
group_title= "관리자페이지"
page_title= "출석현황"
tab_Index= 1
%>
<!--#include virtual="/include/metatag.asp"-->
<!--#include virtual="/include/dbcon.asp"-->
<!--#include virtual="/include/session.asp"-->
<!--#include virtual="/include/function.asp"-->
<%
hakgi_num= request("hg")
'Response.write hakgi_num & "<--hakgi_num<br>"

'select_hakgi용
sql_s="select * from hakgi order by hakgi_num"

'
If Len(hakgi_num) > 0 Then
	sql_h= "select * from hakgi where hakgi_num='" & hakgi_num & "'"
	'Response.write sql_h & "<br>"
	Set rs_h= dbcon.execute(sql_h)
	if rs_h.bof Or rs_h.eof Then
		msg= "해당 학기에 회원이 없습니다."
	Else
		start_date= rs_h("start_date")
		end_date=  rs_h("end_date")


		sql=";with "&_
			"tmp_a as (select * from t_usr where user_id not in ('lmstester','kimts','bella0302' ) "&_
			"	and (regist_date >='" & start_date & "' and regist_date<='" & end_date & "')), "&_
			"tmp_b as ( select user_name, t.user_id, c1, c2, c3, c4, c5, c6, c7, c8, c9,c10, c11, c12, c13, c14, c15, c16, c17, c18, c19,c20, c21, c22, c23, c24, "&_
			"	case when c1='O' then 1 ELSE 0 end as ap1, case when c2='O' then 1 ELSE 0 end as ap2, case when c3='O' then 1 ELSE 0 end as ap3, "&_
			"	case when c4='O' then 1 ELSE 0 end as ap4, case when c5='O' then 1 ELSE 0 end as ap5, case when c6='O' then 1 ELSE 0 end as ap6, "&_
			"	case when c7='O' then 1 ELSE 0 end as ap7, case when c8='O' then 1 ELSE 0 end as ap8, case when c9='O' then 1 ELSE 0 end as ap9, "&_
			"	case when c10='O' then 1 ELSE 0 end as ap10, case when c11='O' then 1 ELSE 0 end as ap11, case when c12='O' then 1 ELSE 0 end as ap12, "&_
			"	case when c13='O' then 1 ELSE 0 end as ap13, case when c14='O' then 1 ELSE 0 end as ap14, case when c15='O' then 1 ELSE 0 end as ap15, "&_
			"	case when c16='O' then 1 ELSE 0 end as ap16, case when c17='O' then 1 ELSE 0 end as ap17, case when c18='O' then 1 ELSE 0 end as ap18, "&_
			"	case when c19='O' then 1 ELSE 0 end as ap19, case when c20='O' then 1 ELSE 0 end as ap20, case when c21='O' then 1 ELSE 0 end as ap21, "&_
			"	case when c22='O' then 1 ELSE 0 end as ap22, case when c23='O' then 1 ELSE 0 end as ap23, case when c24='O' then 1 ELSE 0 end as ap24 "&_
			"	from tmp_a as t "&_
			"	left Join attend as a On t.user_id= a.user_id), "&_
			"tmp_c as (select user_name, user_id, c1, c2, c3, c4, c5, c6, c7, c8, c9,c10, c11, c12, c13, c14, c15, c16, c17, c18, c19,c20, c21, c22, c23, c24, "&_
			"	ap1+ap2+ap3+ap4+ap5+ap6+ap7+ap8+ap9+ap10+ap11+ap12+ap13+ap14+ap15+ap16+ap17+ap18+ap19+ap20+ap21+ap22+ap23+ap24 as apt "&_
			"	from tmp_b), "&_
			"tmp_d as (select *, (24-apt) as mapt, round(convert(float, apt)/24*100,0) as per from tmp_c ) "&_
			"select * from tmp_d"

	End If
Else
	msg= "학기를 선택하십시오."
End if
'sql=";with "&_
'			"tmp_a as ( select *, "&_
'			"	case when c1='O' then 1 ELSE 0 end as ap1, case when c2='O' then 1 ELSE 0 end as ap2, "&_
'			"	case when c3='O' then 1 ELSE 0 end as ap3, case when c4='O' then 1 ELSE 0 end as ap4, "&_
'			"	case when c5='O' then 1 ELSE 0 end as ap5, case when c6='O' then 1 ELSE 0 end as ap6, "&_
'			"	case when c7='O' then 1 ELSE 0 end as ap7, case when c8='O' then 1 ELSE 0 end as ap8, "&_
'			"	case when c9='O' then 1 ELSE 0 end as ap9, case when c10='O' then 1 ELSE 0 end as ap10, "&_
'			"	case when c11='O' then 1 ELSE 0 end as ap11, case when c12='O' then 1 ELSE 0 end as ap12, "&_
'			"	case when c13='O' then 1 ELSE 0 end as ap13, case when c14='O' then 1 ELSE 0 end as ap14, "&_
'			"	case when c15='O' then 1 ELSE 0 end as ap15, case when c16='O' then 1 ELSE 0 end as ap16, "&_
'			"	case when c17='O' then 1 ELSE 0 end as ap17, case when c18='O' then 1 ELSE 0 end as ap18, "&_
'			"	case when c19='O' then 1 ELSE 0 end as ap19, case when c20='O' then 1 ELSE 0 end as ap20, "&_
'			"	case when c21='O' then 1 ELSE 0 end as ap21, case when c22='O' then 1 ELSE 0 end as ap22, "&_
'			"	case when c23='O' then 1 ELSE 0 end as ap23, case when c24='O' then 1 ELSE 0 end as ap24 "&_
'			"	from attend "&_
'			"	where user_id not in ('lmstester','kimts','bella0302' )), "&_
'			"tmp_b as (select user_id, course_num, c1, c2, c3, c4, c5, c6, c7, c8, c9,c10, "&_
'			"	c11, c12, c13, c14, c15, c16, c17, c18, c19,c20, c21, c22, c23, c24, "&_
'			"	ap1+ap2+ap3+ap4+ap5+ap6+ap7+ap8+ap9+ap10+ap11+ap12+ap13+ap14+ap15+ap16+ap17+ap18+ap19+ap20+ap21+ap22+ap23+ap24 as apt "&_
'			"	from tmp_a ), "&_
'			"tmp_c as (select *, (24-apt) as mapt, round(convert(float, apt)/24*100,0) as per from tmp_b ) "&_
'			"select t.user_name, c.* from t_usr as t "&_
'			"left join tmp_c as c On t.user_id= c.user_id "&_
'			"where t.user_id not in ('lmstester','kimts','bella0302' )"&_
'			"order by user_name "
'		Response.write sql

%>
<body>
<div id="wrapper" class="n_swiper">
	<!--#include virtual="/include/header.asp"-->
	<!--#include virtual="/include/menu.asp"-->
	<div id="contents">
		<div id="myclass_con" class="con find_con" >
		<h5><img src="/images/myclass/home.png" alt="home"> <%=group_title%> > <%=page_title%></h5>
		<h1><%=page_title%> </h1>
		<div class="dis_t allim">※ 태블릿 이하 기기에서 접속시, 해당 페이지는 <span class="underline">좌우로 스크롤</span>하여 확인하시기 바랍니다.</div>
		<!--#include virtual="/include/loading.asp"-->
		<!--#include virtual="/admin/admin_tabs.asp"-->
		<div class="mc_ttop">
		<%
		If msg="" Then
		%>
			<div>
				<%
				'Response.write sql
				Set rs=dbcon.execute(sql)
				%>
				<table class="adminT_tp">
					<tr>
						<th>순번</th>
						<th>이름</th>
						<th>아이디</th>
						<th>수강수<br>(강)</th>
						<th>미수강수<br>(강)</th>
						<th>수강율<br>(%)</th>
						<%
						For i=1 To 24
						%>
						<th><%=i%>강</th>
						<%
						Next
						%>
					</tr>
				<%
				If rs.bof Or rs.eof Then
				%>
					<tr>
						<td colspan="30"><br>출석기록이 없습니다.<br><br></td>
					</tr>
				<%
				Else
					q=1
					Do Until rs.eof
					%>
					<tr>
						<td><%=q%></td>
						<td><%=rs("user_name")%></td>
						<td><%=rs("user_id")%></td>
						<td><%=rs("apt")%></td>
						<td><%=rs("mapt")%></td>
						<td><%=rs("per")%></td>
						<%
						For i=1 To 24
						%>
						<th><%=rs("c"&i)%></th>
						<%
						Next
						%>
					</tr>
					<%
						q= q+1
						rs.movenext
					loop
				end If
				%>
				</table>
			</div>
		<%
		Else
			Response.write msg
		End If
		%>
		</div>
	</div>
	<!--#include virtual="/include/footer.asp"-->
</div><!--End wrapper-->

</body>

<script>
	$('#loading').hide();
	var thisTabIndex= "<%=tab_Index%>";
	thisPageTab(thisTabIndex);

	//해당화면에서 아이콘색상 바꾸기
	$(window).resize(function(){
		if (window.innerWidth > 1024) {

		$('.su_orange .nav_icon').css({"background-position":"0 -19px"});

		} else {

		$('.su_orange .nav_icon').css({"background-position":"0 -2.2vw"});

		 }

	}).resize();

	//모바일에서 상단nextslide없애기
	var width_size = window.outerWidth;
	if (width_size <= 640) {
		$('header').css({"height":"20vw"});
		$('#m_header_txt > div').css({"display":"none"});
	}

	$('input[name=submitBtn').click(function(){
		//한글, 영어만 가능
		var nameRule= /[가-힣a-zA-Z]+$/;
		if (!nameRule.test(user_name)) {
			alert("이름을 확인해 주십시오\n한글, 영문만 사용가능합니다.");
			$('input[name=user_name]').focus();
			chk_submit = 0
			return false;
		};
	});

	//인증번호 받기
	$('input[name=certiNoRequestBtn]').click(function() {
		var name= $('input[name=user_name]').val()
		var phone1= $('select[name=phone1]').val();
		var phone2=	$('input[name=phone2]').val();
		var phone3=	$('input[name=phone3]').val();
		var phone= phone1+phone2+phone3
		var divi= "cert";

		if (!name){
			alert("이름를 입력해주십시오. ");
			$('input[name=user_name').focus();
			return false;
		}

		if (!phone2 || !phone3){
			alert("전화번호를 입력해주십시오. ");
			$('input[name=phone2]').focus();
			return false;
		}

		$.get(
			'/include/phone_rnd_send.asp',
			{'nm': name, 'pn': phone, 'divi': divi},
			function(data) {
				//console.log(data)
				if (data=="checkMember"){
					alert("일치하는 회원정보가 없습니다.");
				}
				else{
					alert("인증번호가 발송되었습니다.\n확인 후 인증번호란에 입력해 주십시오.")
					$('.hide_num').show();
					$('input[name=certID]').val(data)
				}
			}
		);
	});

	//인증번호 확인
	$('input[name=certiNoConfirmBtn]').click(function(){
		var certID= $('input[name=certID]').val();
 		var certiNoConfirm= $('input[name=certiNoConfirm]').val()
		if (certID==certiNoConfirm)	{
			alert("인증되었습니다.")
			$('input[name=certIdCfResilt]').val('Y')
		}
		else {
			alert("인증번호가 틀립니다.")
			$('input[name=certIdCfResilt]').val('')
		}
	});

	/*팝업*/
	$('a[href^=#viewattend]').click(function(){
		var wk= $(this).attr('href').substr(8)
		var url= "/admin/popup/attend_popup.asp"
		var pop= window.open(url,"attend_popup","width=700, height=700, top=100");
		pop.focus();
	});
</script>


</html>
